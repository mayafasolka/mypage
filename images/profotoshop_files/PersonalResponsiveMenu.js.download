'use strict';function PersonalResponsiveMenuInit(q){function v(a){jQuery.ajax({type:"GET",url:M.personalMessageSourceUrl,success:function(b){I=b;N=new Date;h.updateMessageCounterBasedOnCookie();a&&m(b)},error:CommonFunctions.alertAjaxError})}function m(a){c.messageDialogContent.empty().html(a);a=-(c.inboxMenuLink.width()/2+ +c.inboxMenuLink.css("padding-right").replace("px","")+ +c.inboxMenuLink.css("border-right-width").replace("px","")+ +c.inboxMenuLink.css("margin-right").replace("px",""));var b=
-(c.inboxMenuLink.height()/2+ +c.inboxMenuLink.css("padding-bottom").replace("px","")+ +c.inboxMenuLink.css("border-bottom-width").replace("px","")+ +c.inboxMenuLink.css("margin-bottom").replace("px",""));t.openDialogAt(a,b,!0);d.isAndroidBrowser||u();c.inboxMenuLink.closest("li").toggleClass(E.opaque,!0);A();F()}function n(){O&&clearTimeout(O);O=setTimeout(u,200)}function u(){var a=c.messageDialogContent,b=G.height()-a.offset().top-(a.outerHeight(!0)-a.height());a.css({"max-height":0>b?0:b,"overflow-y":"auto"})}
function l(a){t=e(a,c.inboxMenuLink,c.messageDialogContent);t.setBeforeCloseDialog(function(){var b=c.inboxMenuLink.closest("li"),k=!!c.messagesBadge.text();b.toggleClass(E.opaque,k)});t.hideHeader();t.hideFooter();t.toggleCloseLink(!1)}function e(a,b,k){a.toggleElement=b;return new ContextDialog(k,a)}function g(a,b,k,r){b.closest("li").toggleClass(E.opaque,r);k.text(f(a,!0));k.toggle(0<a)}function F(){c.messageDialogContent.find("#"+d.messageCounterIds.internalMessagesCounter).text(x(f(y)))}function A(){if(!window.itslearning.settings.app.is_instant_message_system_enabled){var a=
d.primaryCloudEmailType===CloudEmailType.office365?x(f(B,!1)):x(f(C,!1));c.messageDialogContent.find("#"+d.messageCounterIds.cloudMessagesCounter).text(a)}}function f(a,b){return void 0===a||0>=a?"":b&&100<=a?"99+":a}function x(a){return""===a?"":" ("+a+")"}function H(a,b,k,r){var P=a?"touchstart":"click",Q=k.find("li:first-child > button");k.find("a").click(function(){k.hide();r&&r()});b.on(P+" keydown",function(p){if(p.type===P||p.which===CCL.CommonConstants.keyCodes.arrowDown)"false"===$(".c-messages-popup").attr("aria-hidden")&&
$(".c-messages__overlay").click(),k.toggle(),Q.focus()});$(document).on(P+" "+CCL.CommonTriggers.clickInInnerFrame,function(p){if(k.is(":visible")){p=p.target;var J=$(p),S=p===b.get(0)||1===J.closest(b).length;J=!S&&(p===k.get(0)||1===J.closest(k).length);var T=k.find("li:last-child > a");S||J||(k.hide(),window.FreshdeskChat&&window.FreshdeskChat.destroy(),r&&r());T.keydown(p,function(z){z.which!==CCL.CommonConstants.keyCodes.tab||z.shiftKey||(z.preventDefault(),Q.focus())});Q.keydown(p,function(z){z.shiftKey&&
z.which===CCL.CommonConstants.keyCodes.tab&&(z.preventDefault(),T.focus())})}});k.keydown(function(p){p.which===CCL.CommonConstants.keyCodes.escape&&($(k).hide(),r&&r(),b.focus())})}window[q]=this;var h=this,G=jQuery(window),c,d,M,E,D,t,O,R=0,w=0,B=0,C=0,y=0,U,I,K=0,N,L;h.initialize=function(){c=h.controls;d=h.settings;M=h.settings.urls;E=h.settings.cssClasses;D=h.settings.queryStringParameters;L=h.toggleMenuLinkFunction;c.personalMenuLink.on("click",function(){"false"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&
jQuery(InstantMessageSelectors.overlaySelector).click();L()});var a=document.querySelector("button[name=closePersonalMenu]");a&&a.addEventListener("click",function(){c.personalMenuDropDown.hide();L();c.personalMenuLink.focus()});H(d.isIos,c.personalMenuLink,c.personalMenuDropDown,L);c.searchBoxMobile.on("click touchstart touchend",function(b){b.stopPropagation()});c.searchBoxMobile.on(d.searchTextEvent,function(b,k){itslTop.location.href=M.searchMainPageNavigateUrl.replace(d.searchPlaceholder,encodeURIComponent(encodeURIComponent(k)))});
d.shouldOpenMessagesPopUp&&(c.inboxMenuLink.click(function(b){t.isOpened()?t.closeDialog():((b=!I)||(b=N?18E4<(new Date).getTime()-N.getTime():!1),b?v(!0):m(I))}),d.isAndroidBrowser||G.resize(n),G.on("load",function(){v()}));g(0,c.notificationLink,c.notificationsBadge,!1);g(0,c.office365CloudEmailIconLink,c.office365CloudEmailBadge,!1);g(0,c.gmailCloudEmailIconLink,c.gmailCloudEmailBadge,!1);g(0,c.inboxMenuLink,c.messagesBadge,!1);g(0,c.emailMenuLink,c.emailBadge,!1);CommonFunctions.attachPostMessageEventListener(G,
CommonWindowMessages.MessageNames.unseenNotificationCounterChanged,function(b){g(b.extendedData,c.notificationLink,c.notificationsBadge,!!(0<b.extendedData))});CommonFunctions.attachPostMessageEventListener(G,CommonWindowMessages.MessageNames.openGroupChat,function(b){var k="true"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")?!0:!1,r=jQuery("#l-header").is(":hidden");k&&"function"===typeof window.InstantMessageOpenWindowForCollaboration&&window.InstantMessageOpenWindowForCollaboration(b.collaborationId,
function(){jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false");jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden")},r)});d.shouldOpenMessagesPopUp&&l({width:400,setFocus:!1,marginTop:38,marginBottom:0,noTitle:!0,showArrow:!0,align:"center",valign:"bottom",closeButtonTooltip:h.settings.terms.close,cssClass:E.popupContainer,customScripts:{beforeCloseDialog:null}});d.hasInternalMessages&&(U=new RegExp("[\\?&]"+d.onlineInfoCookie.unreadMessagesKey+"=([^&#]*)"))};
h.setUnreadInternalMessages=function(a){d.hasInternalMessages&&a!==w&&(w=a,F())};h.setUnreadEmailMessages=function(a,b){d.hasEmail&&a!==y&&(y=a,K=b)};h.setUnreadCloudEmailMessages=function(a,b){!d.hasCloudEmail||B===a&&C===b||(B=a,C=b,A())};h.updateMessageCounterBasedOnCookie=function(){if(d.hasInternalMessages){var a=U.exec(jQuery.cookie(d.onlineInfoCookie.name));a&&a.length&&(w=parseInt(a[1]),h.setCounts())}};h.setCounts=function(){R&&w!==R&&h.invalidateCache();if(K&&0<K&&window.itslearning.settings.app.is_instant_message_system_enabled){var a=
h.controls.emailMenuLink.attr("href"),b=a.getQueryStringParameter(D.textURL);b=b.setQueryStringParameter(D.emailAccountsRedirect,"False");b=b.setQueryStringParameter(D.emailRedirect,"True");b=b.setQueryStringParameter(D.accountID,K);h.controls.emailMenuLink.attr("href",a.setQueryStringParameter(D.textURL,b))}R=w;a=0;0<w&&(d.hasInternalMessages||d.hasEmail)&&(a+=w,window.itslearning.settings.app.is_instant_message_system_enabled&&(window.itslearning.instantmessaging.unreadInternalMessages=w));(0<B||
0<C)&&d.hasCloudEmail&&(window.itslearning.settings.app.is_instant_message_system_enabled?(g(B,c.office365CloudEmailIconLink,c.office365CloudEmailBadge,!1),g(C,c.gmailCloudEmailIconLink,c.gmailCloudEmailBadge,!1)):a=d.primaryCloudEmailType===CloudEmailType.office365?a+B:a+C);!window.itslearning.settings.app.is_instant_message_system_enabled&&d.hasEmail&&(a+=y);0<y&&d.hasEmail&&g(y,c.emailMenuLink,c.emailBadge,!!(0<y));if(d.hasInternalMessages||d.hasCloudEmail||d.hasEmail)b=0<a||h.settings.shouldOpenMessagesPopUp&&
t.isOpened(),g(a,c.inboxMenuLink,c.messagesBadge,!!b);CommonFunctions.makePostMessageCall(window.itslTop,new CommonWindowMessages.GenericMessageWithData(CommonWindowMessages.MessageNames.unseenNotificationCounterChanged,h.unseenNotifications));window.itslearning.settings.app.is_instant_message_system_enabled&&(a=jQuery.Event("UpdateUnreadMessagesCount"),jQuery(window).trigger(a))};h.invalidateCache=function(){I=void 0};return h}
var CloudEmailType={office365:"Office365",gmail:"Gmail"},InstantMessageSelectors={largeHeaderLogo:".l-logo",mainMenuSelector:"ul.l-main-menu-items",overlayClass:"c-messages__overlay",overlaySelector:".c-messages__overlay",overlayLargeSelector:"c-messages__overlay--largeHeader",overlayBlackClass:"c-messages__overlay--black",popupSelector:".c-messages-popup",popupIconSelector:".l-personal-menu-instantmessage",popupIconSelectedClass:"l-personal-menu-icon-instantmessage-selected"};
function FlyOutPopupInit(q,v){jQuery(InstantMessageSelectors.popupSelector).load(q);v||(jQuery("body").append('<div class="'+InstantMessageSelectors.overlayClass+' is-hidden"></div>'),0<jQuery(InstantMessageSelectors.largeHeaderLogo).length&&jQuery(InstantMessageSelectors.overlaySelector).addClass(InstantMessageSelectors.overlayLargeSelector),jQuery(InstantMessageSelectors.popupIconSelector).on("click",function(){var m=jQuery(this);"true"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")?
(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),jQuery(InstantMessageSelectors.mainMenuSelector).on("click",function(n){jQuery(InstantMessageSelectors.mainMenuSelector).off("click");"false"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&jQuery(InstantMessageSelectors.overlaySelector).click()}),"undefined"!==typeof window.InstantMessageOpenWindow&&window.InstantMessageOpenWindow()):
jQuery(InstantMessageSelectors.overlaySelector).click();jQuery(m).closest("li").toggleClass(InstantMessageSelectors.popupIconSelectedClass)}),jQuery(InstantMessageSelectors.overlaySelector).on("click",function(m){m=jQuery(m.target);if(m.hasClass(InstantMessageSelectors.overlayClass)||m.hasClass(InstantMessageSelectors.overlayBlackClass))jQuery(this).closest("li").toggleClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass(InstantMessageSelectors.overlayBlackClass),
jQuery(InstantMessageSelectors.overlaySelector).addClass("is-hidden"),jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","true"),"undefined"!==typeof window.InstantMessageCloseWindow&&window.InstantMessageCloseWindow()}))}
function OpenInstantMessageSendNew(q){window.itslearning.settings.app.enableModernInstantMessages?setTimeout(()=>window.dispatchEvent(new CustomEvent("showNewMessageWithPreSelectedRecipients",{detail:q})),50):"undefined"!==typeof window.showInstantMessageSendNew&&(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.popupIconSelector).closest("li").addClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),
window.showInstantMessageSendNew(q))}function OpenInstantMessageModal(){"undefined"!==typeof window.InstantMessageOpenModalWindow?openInstentMessageModalWindow():window.setTimeout(openInstentMessageModalWindow,3E3)}
function openInstentMessageModalWindow(){"undefined"!==typeof window.InstantMessageOpenModalWindow&&(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.popupIconSelector).closest("li").addClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),window.InstantMessageOpenModalWindow())}
jQuery(()=>{if(window.itslearning.settings.app.isNewSignalREnabled){if(window.itslearning.settings.app.is_instant_message_system_enabled){let n=0,u;const l=(new signalR.HubConnectionBuilder).withUrl(itslearning.settings.app.signalRUrl,{skipNegotiation:!0,transport:signalR.HttpTransportType.WebSockets}).configureLogging(signalR.LogLevel.Warning).withAutomaticReconnect().build(),e=f=>{jQuery(window).trigger(jQuery.Event("SignalRConnectionStatus"),f);window.dispatchEvent(new CustomEvent("SignalRConnectionStatus2",
{detail:{status:f}}))};"undefined"!==typeof l&&null!==l&&(l.on("AlertNewMessage",f=>{jQuery(window).trigger(jQuery.Event("NewSignalRInstantMessage"),JSON.parse(f));window.dispatchEvent(new CustomEvent("NewSignalRInstantMessage2",{detail:{thread:f}}))}),l.on("AlertThreadDeleted",f=>{jQuery(window).trigger(jQuery.Event("SignalRThreadDeleted"),f)}));const g=f=>{let x="";localStorage.getItem("instantmessage-channelid")&&(x=localStorage.getItem("instantmessage-channelid"));let H="/restapi/personal/instantmessages/communicationchannel/{channelId}/v1".replace("{channelId}",
f);5<x.length&&(H=`${H}?unregister=${x}`);CCL.CommonFunctions.safeAjaxPost({url:H,headers:{[itslearning.settings.app.antiForgeryHeaderName]:itslearning.settings.app.antiForgeryHeaderValue}}).done(()=>{e(!0);console.log(`SignalR connection registered. ChannelId: ${f}`);A(!1)}).fail(()=>console.log(`SignalR connection could not be registered. ChannelId: ${f}`));localStorage.setItem("instantmessage-channelid",f)},F=()=>l.start().then(()=>l.invoke("GetConnectionId")).then(f=>g(f)).catch(f=>{e(!1);A(!0);
console.log(`Error starting SignalR connection. ChannelId: ${f}`)}),A=f=>{f?10>=n&&(n+=1,window.clearInterval(u),u=window.setInterval(F,3E4)):(window.clearInterval(u),n=0)};F();l.onreconnecting(()=>{e(!1);console.log("SignalR connection reconnecting.")});l.onclose(()=>{e(!1);console.log("SignalR connection disconnected.");A(!0)});l.onreconnected(()=>{console.log("SignalR connection reconnected. Trying to get ChannelId.");l.invoke("GetConnectionId").then(f=>{console.log(`SignalR connection reconnected. New ChannelId: ${f}`);
g(f)})})}}else if(window.itslearning.settings.app.is_instant_message_system_enabled){var q=0,v;jQuery.connection.hub.url=window.itslearning.settings.app.signal_r_endpoint;var m=jQuery.connection.instantMessageHub;function n(e){var g=jQuery.Event("SignalRConnectionStatus");jQuery(window).trigger(g,e);window.dispatchEvent(new CustomEvent("SignalRConnectionStatus2",{detail:{status:e}}))}"undefined"!==typeof m&&null!==m&&(m.client.alertNewMessage=function(e){e=JSON.parse(e);var g=jQuery.Event("NewSignalRInstantMessage");
jQuery(window).trigger(g,e);window.dispatchEvent(new CustomEvent("NewSignalRInstantMessage2",{detail:{thread:e}}))},m.client.alertThreadDeleted=function(e){var g=jQuery.Event("SignalRThreadDeleted");jQuery(window).trigger(g,e)});function u(){jQuery.connection.hub.start().done(function(){var e="";localStorage.getItem("instantmessage-channelid")&&(e=localStorage.getItem("instantmessage-channelid"));var g="/restapi/personal/instantmessages/communicationchannel/{channelId}/v1".replace("{channelId}",jQuery.connection.hub.id);
5<e.length&&(g=g+"?unregister="+e);e={};e[itslearning.settings.app.antiForgeryHeaderName]=itslearning.settings.app.antiForgeryHeaderValue;CCL.CommonFunctions.safeAjaxPost({url:g,headers:e}).done(function(){n(!0);l(!1);console.log("SignalR connection registered. ChannelId: "+jQuery.connection.hub.id)});localStorage.setItem("instantmessage-channelid",jQuery.connection.hub.id)}).fail(function(e){n(!1);l(!0);console.log("Error starting SignalR connection: "+e)})}function l(e){e?10>=q&&(q+=1,window.clearInterval(v),
v=window.setInterval(u,3E4)):(window.clearInterval(v),q=0)}u();jQuery.connection.hub.connectionSlow(function(){console.log("We are currently experiencing difficulties with the connection.")});jQuery.connection.hub.reconnecting(function(){n(!1);console.log("SignalR connection reconnecting.")});jQuery.connection.hub.disconnected(function(){n(!1);console.log("SignalR connection disconnected.");l(!0)});jQuery.connection.hub.reconnected(function(){n(!0);console.log("SignalR connection reconnected.");l(!1)})}});
